var nt=(t,e=0,r=1)=>e+(r-e)*t,v=(t,e=0,r=0)=>t<r?r:t>e?e:t,T=(t=0,e=0)=>Math.random()*(t-e)+e,k=(...t)=>Math.floor(T(...t));function st(t){if(t===void 0||typeof t!="function")throw new TypeError("missing callback");let e=h=>window.requestAnimationFrame(h),r,n=h=>{t(h,r),r&&(r=e(n))},o=()=>(r=r||e(n),r),a=()=>(r=r&&window.cancelAnimationFrame(r),r);return{start:o,stop:a,play:o,pause:a}}function ot(...t){let e=ft(...t);return{gl:e,createFramebuffer:dt(e),createIbo:ht(e),createProgram:it(e),createTexture:ct(e),createVbo:ut(e),getUniformLocations:lt(e)}}function at(t){return function(r){let n=t.createShader(r);return function(a){if(t.shaderSource(n,a),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS))throw new Error(`glx: failed to compile shader: ${t.getShaderInfoLog(n)}`);return n}}}function it(t){let e=at(t),r=e(t.FRAGMENT_SHADER),n=e(t.VERTEX_SHADER);return function(a,h){let i=t.createProgram(),c=r(h),d=n(a);if(t.attachShader(i,c),t.attachShader(i,d),t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS))throw new Error(`glx: failed to link program: ${t.gl.getProgramInfoLog(i)}`);if(t.deleteShader(c),t.deleteShader(d),t.validateProgram(i),!t.getProgramParameter(i,t.VALIDATE_STATUS))throw new Error(`glx: failed to validate program: ${t.gl.getProgramInfoLog(i)}`);return i}}function ct(t){return function(r,n,o=t.createTexture()){return t.bindTexture(t.TEXTURE_2D,o),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),new Promise((a,h)=>{if(r){let i=new Image;i.onerror=c=>{h(c)},i.onload=()=>{let{width:c,height:d}=i;t.texImage2D(t.TEXTURE_2D,0,t.RGBA,c,d,0,t.RGBA,t.UNSIGNED_BYTE,i),a(o)},i.src=r,n!==void 0&&(i.crossOrigin=n)}else a(o)})}}function ut(t){return(e,r=t.STATIC_DRAW)=>{let n=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,n),t.bufferData(t.ARRAY_BUFFER,e,r),t.bindBuffer(t.ARRAY_BUFFER,null),n}}function ht(t){return(e,r=t.STATIC_DRAW)=>{let n=t.createBuffer();return t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,n),t.bufferData(t.ELEMENT_ARRAY_BUFFER,e,r),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),n}}function dt(t){return(e,r=e)=>{let n=t.createFramebuffer();return t.bindFramebuffer(t.FRAMEBUFFER,n),t.viewport(0,0,e,r),n}}function lt(t){return(e,r)=>{let n={};for(let o of r)n[o]=t.getUniformLocation(e,o);return n}}function ft(t,e){let{types:r,attributes:n}={types:["webgl2","webgl","experimental-webgl"],attributes:{antialias:!0},...e};for(let o of r)try{let a=t?.getContext(o,n);if(a)return a;throw new Error("glx: failed to create WebGL context")}catch(a){throw a}}var mt=`#version 300 es
in vec2 aPosition;

uniform vec2 uResolution;

out vec2 vTextureCoord;

void main() {
  // Convert from pixels to 0 -> 1.
  vTextureCoord = aPosition / uResolution;

  gl_Position = vec4(((vTextureCoord * 2.0) - 1.0) * vec2(1, -1), 0, 1);
}`,pt=`#version 300 es
precision highp float;

in vec2 vTextureCoord;

uniform sampler2D uSampler;
uniform float uThreshold;

out vec4 oColor;

void main() {
  vec4 c = texture(uSampler, vTextureCoord);
  float metaball = c.a > uThreshold ? 1.0 : 0.0;

  c.a = metaball;
  c.rgb = c.rgb * metaball;

  oColor = c;
}`,Y=2*Math.PI;function Et(t=0,e=1){return{x:e*Math.cos(t),y:e*Math.sin(t)}}var A=class{constructor(e=0,r=0){this.x=e,this.y=r}angle(){return Math.atan2(this.y,this.x)}length(){return Math.hypot(this.x,this.y)}dot(e={}){let{x:r=e,y:n=e}=e;return this.x*r+this.y*n}add(e={}){let{x:r=e,y:n=e}=e;return E(this.x+r,this.y+n)}subtract(e={}){let{x:r=e,y:n=e}=e;return E(this.x-r,this.y-n)}multiply(e={}){let{x:r=e,y:n=e}=e;return E(this.x*r,this.y*n)}divide(e={}){let{x:r=e,y:n=e}=e;return E(this.x/r,this.y/n)}plus(e){return this.copy(this.add(e))}minus(e){return this.copy(this.subtract(e))}times(e){return this.copy(this.multiply(e))}over(e){return this.copy(this.divide(e))}copy(e={}){let{x:r=e,y:n=e}=e;return this.x=r,this.y=n,this}clone(){return E(this.x,this.y)}equals(e){return this.x===e.x&&this.y===e.y}invert(){return this.times(-1)}normalize(){return this.over(this.length())}};function E(t,e){return new A(t,e)}function G(t,e,r,n){return(1-n)*(1-n)*t+2*(1-n)*n*r+n*n*e}function bt(t){return[parseInt(t.substring(1,3),16),parseInt(t.substring(3,5),16),parseInt(t.substring(5,7),16)]}function Tt(t,e=performance.now()){return(r=e,n=250)=>{r-e<=n&&t(e),e=r}}function xt(t=0,e=2){if(t===0)return"0 b";let r=["b","Kb","Mb","Gb","Tb","Pb","Eb","Zb","Yb"],n=Math.max(0,e),o=Math.floor(Math.log(t)/Math.log(1024));return`${parseFloat((t/Math.pow(1024,o)).toFixed(n))} ${r[o]}`}function x(t=""){return document.createRange().createContextualFragment(t)}var gt=["#fa5619","#243470","#efc126","#0d070b","#fffffd"],{createObjectURL:Rt,revokeObjectURL:wt}=self.URL||self.webkitURL,yt=gt.map(t=>new Promise((e,r)=>{let[n,o,a]=bt(t),h=`<svg
      height="10"
      width="10"
      xmlns="http://www.w3.org/2000/svg"
      xmlns:xlink="http://www.w3.org/1999/xlink">
      <defs>
        <radialGradient id="gradient">
          <stop offset="0%" stop-color="rgba(${n}, ${o}, ${a}, 0.9)" />
          <stop offset="90%" stop-color="rgba(${n}, ${o}, ${a}, 0.0)" />
        </radialGradient>
      </defs>
      <circle cx="5" cy="5" r="5" fill="url('#gradient')" />
    </svg>`,i=new Blob([h],{type:"image/svg+xml"}),c=Rt(i),d=new Image;d.onload=()=>{wt(c),e(d)},d.onerror=R=>{r(R)},d.src=c})),O=await Promise.all(yt);function V(){let t=O.shift();return O.push(t),t}var P=class extends A{constructor(e,r){super(e,r),this.t=performance.now()}},F=class{constructor(e=0,r=0,n=0){this.x=e,this.y=r,this.r=n,this.d=2*n}},I=class{constructor(e=1){this.brush=new V,this.drops=[],this.steps=[],this.sensitivity=e}draw(e){for(;this.drops.length>0;){let{x:r,y:n,r:o,d:a}=this.drops.shift();e.drawImage(this.brush,r-o,n-o,a,a)}return this}tick(e=performance.now()){if(this.steps=this.steps.filter(u=>e-u.t<200),e-this?.lastStep?.t>7.5&&this.step(this.lastStep.x,this.lastStep.y),this.done)return delete this.lastStep,delete this.lastTail,this;let{0:r,[this.steps.length-1]:n}=this.steps,o=this.lastTail??this.steps.at(-2)??r,a=n;this.lastTail=n;let h=1/(this.steps.length*this.sensitivity),i=[...this.steps].reverse().reduce((u,l,f,U)=>f?u.concat(l.subtract(U[f-1])):u,[]).reduce((u,l)=>u.add(l),E()).times(h),c=i.length(),d=a.subtract(o),R=o.add(d.multiply(.5)).add(i.multiply(Math.max(0,1-Math.log(c)))),N=Math.max(2,(c-10)*.25+T(-2,2)),J=1/d.length();for(let u=0;u<=1;u+=J){let l=G(o.x,a.x,R.x,u),f=G(o.y,a.y,R.y,u);this.drop(l,f,N)}Array.from({length:v(k(Math.max(0,c-20)*5),1e3)},()=>c).map(u=>u*.05).forEach(u=>{let l=nt(Math.min(1,u),Math.random(),Math.pow(Math.random(),4)*u),f=T(Math.PI,-Math.PI)/3,U=-1*Math.sin(f)*Math.cos(f),tt=Math.pow(Math.random(),4)*Math.min(1/l,1)*c*.5,{x:et,y:rt}=E(i.multiply(l).dot(U)).plus(a);this.drop(et,rt,tt)});let X=n.t-r.t,Q=T(X*.1),q=T(X*.3);return Array.from({length:v(2-c/5,1e3)},()=>T(Y)).map(u=>Et(u,q)).forEach(u=>{let{x:l,y:f}=n.add(u);this.drop(l,f,Q)}),this}drop(e,r,n){let o=new F(e,r,n);this.drops.push(o)}step(e,r){return this.lastStep=new P(e,r),this}set lastStep(e){this.steps.push(e)}get done(){return this.steps.length===0}},L=class{constructor(e=0,r=e,n=0){this.max=n,this.x=e,this.y=r}reset(e,r,n){this.max=n??this.max,this.x=e??this.x,this.y=r??this.y}walk(e=1,r=this.max){let n=Math.min(e,r),o=k(Y);return this.x+=n*Math.cos(o),this.y+=n*Math.sin(o),this}},vt=(t=Math.random())=>Math.tan(Math.PI*(t-.5)),At=t=>(e=Math.random())=>1/Math.pow(1-e,1/t),_=document.querySelector("#save"),b=document.querySelector("progress"),_t=document.querySelector("#clear"),w=document.querySelector("#draw"),g=document.querySelector("#statusline"),S=document.querySelector("canvas"),$=st(Ot),Mt={preserveDrawingBuffer:!0},{gl:s,createVbo:St,createProgram:Ut}=ot(S,{attributes:Mt}),B=S.cloneNode().getContext("2d"),{width:m,height:p}=S,Pt=[1,1,1],Ft=[...Pt,0],It=Float32Array.BYTES_PER_ELEMENT,W=new Float32Array([0,0,0,p,m,0,m,0,0,p,m,p]),y=Ut(mt,pt),Lt=St(W),D=s.getAttribLocation(y,"aPosition");D!==-1&&s.enableVertexAttribArray(D);var Bt=s.getUniformLocation(y,"uResolution"),Dt=s.getUniformLocation(y,"uSampler"),Ct=s.getUniformLocation(y,"uThreshold"),H=s.createTexture();s.activeTexture(s.TEXTURE0+0);s.bindTexture(s.TEXTURE_2D,H);s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST);s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST);s.useProgram(y);var{searchParams:C}=new URL(document.location),kt=C.has("cauchy")?vt:At(1.26),$t=C.has("duration")?C.get("duration"):10;200*parseInt($t,10);var z=new I,Nt=(...t)=>Array.from({length:t.length},(e,r)=>k(0,t.at(r))),Xt=[m,p].map(t=>t*.5),Gt=Tt(()=>{z.brush=new V}),j=[],M=new Proxy(j,{set(t,e,r){let n=Reflect.set(t,e,r);if(t.length&&e==="length"){let o=parseInt(t.length%20/20*100,10),a=String(o).padStart(3," ");o?(g.replaceChildren(x(`Running&hellip; <code>${a}%</code>`)),b.setAttribute("value",o),_.removeAttribute("disabled")):(g.replaceChildren(x(`Okay, <code>${t.length}</code> frames in store`)),b.setAttribute("value",0),w.removeAttribute("disabled"))}return t.length&&t.length%20===0&&$.stop(),t.length?_.removeAttribute("disabled"):w.removeAttribute("disabled"),n}}),K=new L(...Xt,50),Z=new Worker("worker.js");Z.addEventListener("message",t=>{let{image:e,step:r,error:n}=t.data;if(n&&(b.setAttribute("value",0),console.error(n)),r){let{index:o,total:a}=r,{length:h}=String(a),i=parseInt((o+1)/a*100,10),c=String(i).padStart(h," ");g.replaceChildren(x(`Processing&hellip; <code>${c}%</code>`)),b.setAttribute("value",i)}if(e){let{data:o,size:a}=e,h=`Splash.${Date.now()}.gif`,i=`<a href="data:image/gif;base64,${o}" download="${h}"><strong>${h}</strong></a>`,c=xt(a);M.splice(0,M.length),g.replaceChildren(x(`All set! ${i} <code>${c}</code>`)),b.setAttribute("value",0)}});w.addEventListener("click",function(){w.setAttribute("disabled",""),g.replaceChildren(x("Running&hellip;")),K.reset(...Nt(m,p)),b.removeAttribute("value"),$.start()},{passive:!0});_t.addEventListener("click",function(){B.clearRect(0,0,m,p),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)});_.addEventListener("click",function(){M.length!==0&&(w.setAttribute("disabled",""),_.setAttribute("disabled",""),g.replaceChildren(x("Uploading&hellip;")),Z.postMessage({store:j}),b.removeAttribute("value"),$.stop())},{passive:!0});function Ot(t,e){let r=kt(),n=K.walk(r),o=v(n.x,m),a=v(n.y,p);z.step(o,a).tick().draw(B),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,m,p,0,s.RGBA,s.UNSIGNED_BYTE,B.canvas),s.generateMipmap(s.TEXTURE_2D),s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),s.clearColor(...Ft),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),s.bindBuffer(s.ARRAY_BUFFER,Lt),s.uniform2f(Bt,m,p),s.uniform1i(Dt,H),s.uniform1f(Ct,.75),s.vertexAttribPointer(D,2,s.FLOAT,s.TRUE,2*It,0),s.drawArrays(s.TRIANGLES,0,W.length/2),e%100===0&&Gt(),e%10===0&&M.push(S.toDataURL())}
