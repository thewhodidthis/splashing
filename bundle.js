var D=2*Math.PI,st=(e,t=0,r=1)=>t+(r-t)*e,T=(e,t=0,r=0)=>e<r?r:e>t?t:e,x=(e=0,t=0)=>Math.random()*(e-t)+t,P=(...e)=>Math.floor(x(...e)),ot=e=>{if(e===void 0||typeof e!="function")throw TypeError("Missing callback");let t=i=>window.requestAnimationFrame(i),r,s=i=>{e(i,r),r&&(r=t(s))},n=()=>(r=r||t(s),r),a=()=>(r=r&&window.cancelAnimationFrame(r),r);return{start:n,stop:a,play:n,pause:a}};function nt(...e){let t=dt(...e);return{context:t,createFramebuffer:ht(t),createIbo:ut(t),createProgram:it(t),createVbo:ct(t),getUniformLocations:lt(t)}}function at(e){return t=>r=>{let s=e.createShader(t);if(e.shaderSource(s,r),e.compileShader(s),!e.getShaderParameter(s,e.COMPILE_STATUS))throw new Error(`glx.shaderCompiler: failed: ${e.getShaderInfoLog(s)}`);return s}}function it(e){let t=at(e),r=t(e.VERTEX_SHADER),s=t(e.FRAGMENT_SHADER);return(n,a)=>{let i=e.createProgram(),h=r(n),u=s(a);if(e.attachShader(i,h),e.attachShader(i,u),e.linkProgram(i),!e.getProgramParameter(i,e.LINK_STATUS))throw new Error(`glx.createProgram: failed: ${e.getProgramInfoLog(i)}`);if(e.deleteShader(u),e.deleteShader(h),e.validateProgram(i),!e.getProgramParameter(i,e.VALIDATE_STATUS))throw new Error(`glx.createProgram: failed: ${e.getProgramInfoLog(i)}`);return i}}function ct(e){return(t,r=e.STATIC_DRAW)=>{let s=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,s),e.bufferData(e.ARRAY_BUFFER,t,r),e.bindBuffer(e.ARRAY_BUFFER,null),s}}function ut(e){return(t,r=e.STATIC_DRAW)=>{let s=e.createBuffer();return e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,s),e.bufferData(e.ELEMENT_ARRAY_BUFFER,t,r),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),s}}function ht(e){return()=>{let t=e.createFramebuffer();return e.bindFramebuffer(e.FRAMEBUFFER,t),t}}function lt(e){return(t,r)=>{let s={};for(let n of r)s[n]=e.getUniformLocation(t,n);return s}}function dt(e,t){let{types:r,attributes:s}={types:["webgl2","webgl","experimental-webgl"],attributes:{antialias:!0},...t};for(let n of r)try{let a=e?.getContext(n,s);if(!a)throw new Error("glx: failed to create WebGL context");return a}catch(a){throw a}}var ft=`#version 300 es
in vec2 aPosition;

uniform vec2 uResolution;

out vec2 vTextureCoord;

void main() {
  // Convert from pixels to 0 -> 1.
  vTextureCoord = aPosition / uResolution;

  gl_Position = vec4(((vTextureCoord * 2.0) - 1.0) * vec2(1, -1), 0, 1);
}`,pt=`#version 300 es
precision highp float;

in vec2 vTextureCoord;

uniform sampler2D uSampler;
uniform float uThreshold;

out vec4 oColor;

void main() {
  vec4 c = texture(uSampler, vTextureCoord);
  float metaball = c.a > uThreshold ? 1.0 : 0.0;

  c.a = metaball;
  c.rgb = c.rgb * metaball;

  oColor = c;
}`,_=class{constructor(t=0,r=0){this.x=t,this.y=r}angle(){return Math.atan2(this.y,this.x)}length(){return Math.hypot(this.x,this.y)}dot(t={}){let{x:r=t,y:s=t}=t;return this.x*r+this.y*s}add(t={}){let{x:r=t,y:s=t}=t;return b(this.x+r,this.y+s)}subtract(t={}){let{x:r=t,y:s=t}=t;return b(this.x-r,this.y-s)}multiply(t={}){let{x:r=t,y:s=t}=t;return b(this.x*r,this.y*s)}divide(t={}){let{x:r=t,y:s=t}=t;return b(this.x/r,this.y/s)}plus(t){return this.copy(this.add(t))}minus(t){return this.copy(this.subtract(t))}times(t){return this.copy(this.multiply(t))}over(t){return this.copy(this.divide(t))}copy(t={}){let{x:r=t,y:s=t}=t;return this.x=r,this.y=s,this}clone(){return b(this.x,this.y)}equals(t){return this.x===t.x&&this.y===t.y}invert(){return this.times(-1)}normalize(){return this.over(this.length())}};function b(e,t){return new _(e,t)}var mt=(e=0,t=1)=>({x:t*Math.cos(e),y:t*Math.sin(e)});function k(e,t,r,s){return(1-s)*(1-s)*e+2*(1-s)*s*r+s*s*t}function bt(e){return[parseInt(e.substring(1,3),16),parseInt(e.substring(3,5),16),parseInt(e.substring(5,7),16)]}function gt(e,t=performance.now()){return(r=t,s=250)=>{r-t<=s&&e(t),t=r}}function xt(e=0,t=2){if(e===0)return"0 b";let r=["b","Kb","Mb","Gb","Tb","Pb","Eb","Zb","Yb"],s=Math.max(0,t),n=Math.floor(Math.log(e)/Math.log(1024));return`${parseFloat((e/Math.pow(1024,n)).toFixed(s))} ${r[n]}`}function y(e=""){return document.createRange().createContextualFragment(e)}var yt=["#fa5619","#243470","#efc126","#0d070b","#fffffd"],{createObjectURL:Et,revokeObjectURL:wt}=self.URL||self.webkitURL,vt=yt.map(e=>new Promise((t,r)=>{let[s,n,a]=bt(e),i=`<svg
      height="10"
      width="10"
      xmlns="http://www.w3.org/2000/svg"
      xmlns:xlink="http://www.w3.org/1999/xlink">
      <defs>
        <radialGradient id="gradient">
          <stop offset="0%" stop-color="rgba(${s}, ${n}, ${a}, 0.9)" />
          <stop offset="90%" stop-color="rgba(${s}, ${n}, ${a}, 0.0)" />
        </radialGradient>
      </defs>
      <circle cx="5" cy="5" r="5" fill="url('#gradient')" />
    </svg>`,h=new Blob([i],{type:"image/svg+xml"}),u=Et(h),m=new Image;m.onload=()=>{wt(u),t(m)},m.onerror=w=>{r(w)},m.src=u})),$=await Promise.all(vt);function N(){let e=$.shift();return $.push(e),e}var G=class extends _{constructor(t,r){super(t,r);this.t=performance.now()}},Y=class{constructor(t=0,r=0,s=0){this.x=t,this.y=r,this.r=s,this.d=2*s}},O=class{constructor(t=1){this.brush=new N,this.drops=[],this.steps=[],this.sensitivity=t}draw(t){for(;this.drops.length>0;){let{x:r,y:s,r:n,d:a}=this.drops.shift();t.drawImage(this.brush,r-n,s-n,a,a)}return this}tick(t=performance.now()){if(this.steps=this.steps.filter(c=>t-c.t<200),t-this?.lastStep?.t>7.5&&this.step(this.lastStep.x,this.lastStep.y),this.done)return delete this.lastStep,delete this.lastTail,this;let{0:r,[this.steps.length-1]:s}=this.steps,n=this.lastTail??this.steps.at(-2)??r,a=s;this.lastTail=s;let i=1/(this.steps.length*this.sensitivity),h=[...this.steps].reverse().reduce((c,l,d,F)=>d?c.concat(l.subtract(F[d-1])):c,[]).reduce((c,l)=>c.add(l),b()).times(i),u=h.length(),m=a.subtract(n),w=n.add(m.multiply(.5)).add(h.multiply(Math.max(0,1-Math.log(u)))),Z=Math.max(2,(u-10)*.25+x(-2,2)),J=1/m.length();for(let c=0;c<=1;c+=J){let l=k(n.x,a.x,w.x,c),d=k(n.y,a.y,w.y,c);this.drop(l,d,Z)}Array.from({length:T(P(Math.max(0,u-20)*5),1e3)},()=>u).map(c=>c*.05).forEach(c=>{let l=st(Math.min(1,c),Math.random(),Math.pow(Math.random(),4)*c),d=x(Math.PI,-Math.PI)/3,F=-1*Math.sin(d)*Math.cos(d),tt=Math.pow(Math.random(),4)*Math.min(1/l,1)*u*.5,{x:et,y:rt}=b(h.multiply(l).dot(F)).plus(a);this.drop(et,rt,tt)});let C=s.t-r.t,Q=x(C*.1),q=x(C*.3);return Array.from({length:T(2-u/5,1e3)},()=>x(D)).map(c=>mt(c,q)).forEach(c=>{let{x:l,y:d}=s.add(c);this.drop(l,d,Q)}),this}drop(t,r,s){let n=new Y(t,r,s);this.drops.push(n)}step(t,r){return this.lastStep=new G(t,r),this}set lastStep(t){this.steps.push(t)}get done(){return this.steps.length===0}},X=class{constructor(t=0,r=t,s=0){this.max=s,this.x=t,this.y=r}reset(t,r,s){this.max=s??this.max,this.x=t??this.x,this.y=r??this.y}walk(t=1,r=this.max){let s=Math.min(t,r),n=P(D);return this.x+=s*Math.cos(n),this.y+=s*Math.sin(n),this}},Rt=(e=Math.random())=>Math.tan(Math.PI*(e-.5)),Tt=e=>(t=Math.random())=>1/Math.pow(1-t,1/e),A=document.querySelector("#save"),g=document.querySelector("progress"),At=document.querySelector("#clear"),v=document.querySelector("#draw"),E=document.querySelector("#statusline"),S=document.querySelector("canvas"),U=ot(Yt),St={preserveDrawingBuffer:!0},{context:o,createVbo:Mt,createProgram:Ft}=nt(S,{attributes:St}),L=S.cloneNode().getContext("2d"),{width:f,height:p}=S,Pt=[1,1,1],_t=[...Pt,0],Ut=Float32Array.BYTES_PER_ELEMENT,V=new Float32Array([0,0,0,p,f,0,f,0,0,p,f,p]),R=Ft(ft,pt),Lt=Mt(V),I=o.getAttribLocation(R,"aPosition");I!==-1&&o.enableVertexAttribArray(I);var It=o.getUniformLocation(R,"uResolution"),Bt=o.getUniformLocation(R,"uSampler"),Ct=o.getUniformLocation(R,"uThreshold"),H=o.createTexture();o.activeTexture(o.TEXTURE0+0);o.bindTexture(o.TEXTURE_2D,H);o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.NEAREST);o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.NEAREST);o.useProgram(R);var{searchParams:B}=new URL(document.location),Dt=B.has("cauchy")?Rt:Tt(1.26),kt=B.has("duration")?B.get("duration"):10;200*parseInt(kt,10);var W=new O,$t=(...e)=>Array.from({length:e.length},(t,r)=>P(0,e.at(r))),Nt=[f,p].map(e=>e*.5),Gt=gt(()=>{W.brush=new N}),z=[],M=new Proxy(z,{set(e,t,r){let s=Reflect.set(e,t,r);if(e.length&&t==="length"){let n=parseInt(e.length%20/20*100,10),a=String(n).padStart(3," ");n?(E.replaceChildren(y(`Running&hellip; <code>${a}%</code>`)),g.setAttribute("value",n),A.removeAttribute("disabled")):(E.replaceChildren(y(`Okay, <code>${e.length}</code> frames in store`)),g.setAttribute("value",0),v.removeAttribute("disabled"))}return e.length&&e.length%20==0&&U.stop(),e.length?A.removeAttribute("disabled"):v.removeAttribute("disabled"),s}}),j=new X(...Nt,50),K=new Worker("worker.js");K.addEventListener("message",e=>{let{image:t,step:r,error:s}=e.data;if(s&&(g.setAttribute("value",0),console.error(s)),r){let{index:n,total:a}=r,{length:i}=String(a),h=parseInt((n+1)/a*100,10),u=String(h).padStart(i," ");E.replaceChildren(y(`Processing&hellip; <code>${u}%</code>`)),g.setAttribute("value",h)}if(t){let{data:n,size:a}=t,i=`Splash.${Date.now()}.gif`,h=`<a href="data:image/gif;base64,${n}" download="${i}"><strong>${i}</strong></a>`,u=xt(a);M.splice(0,M.length),E.replaceChildren(y(`All set! ${h} <code>${u}</code>`)),g.setAttribute("value",0)}});v.addEventListener("click",function(){v.setAttribute("disabled",""),E.replaceChildren(y("Running&hellip;")),j.reset(...$t(f,p)),g.removeAttribute("value"),U.start()},{passive:!0});At.addEventListener("click",function(){L.clearRect(0,0,f,p),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT)});A.addEventListener("click",function(){M.length!==0&&(v.setAttribute("disabled",""),A.setAttribute("disabled",""),E.replaceChildren(y("Uploading&hellip;")),K.postMessage({store:z}),g.removeAttribute("value"),U.stop())},{passive:!0});function Yt(e,t){let r=Dt(),s=j.walk(r),n=T(s.x,f),a=T(s.y,p);W.step(n,a).tick().draw(L),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,f,p,0,o.RGBA,o.UNSIGNED_BYTE,L.canvas),o.generateMipmap(o.TEXTURE_2D),o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(..._t),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),o.bindBuffer(o.ARRAY_BUFFER,Lt),o.uniform2f(It,f,p),o.uniform1i(Bt,H),o.uniform1f(Ct,.75),o.vertexAttribPointer(I,2,o.FLOAT,o.TRUE,2*Ut,0),o.drawArrays(o.TRIANGLES,0,V.length/2),t%100==0&&Gt(),t%10==0&&M.push(S.toDataURL())}
