var st=(t,e=0,r=1)=>e+(r-e)*t,v=(t,e=0,r=0)=>t<r?r:t>e?e:t,T=(t=0,e=0)=>Math.random()*(t-e)+e,k=(...t)=>Math.floor(T(...t));function nt(t){if(t===void 0||typeof t!="function")throw new TypeError("missing callback");let e=h=>window.requestAnimationFrame(h),r,s=h=>{t(h,r),r&&(r=e(s))},o=()=>(r=r||e(s),r),a=()=>(r=r&&window.cancelAnimationFrame(r),r);return{start:o,stop:a,play:o,pause:a}}function ot(...t){let e=ft(...t);return{gl:e,createFramebuffer:dt(e),createIbo:ht(e),createProgram:it(e),createTexture:ct(e),createVbo:ut(e),getUniformLocations:lt(e)}}function at(t){return function(r){let s=t.createShader(r);return function(a){if(t.shaderSource(s,a),t.compileShader(s),!t.getShaderParameter(s,t.COMPILE_STATUS))throw new Error(`glx: failed to compile shader: ${t.getShaderInfoLog(s)}`);return s}}}function it(t){let e=at(t),r=e(t.FRAGMENT_SHADER),s=e(t.VERTEX_SHADER);return function(a,h){let i=t.createProgram(),c=r(h),d=s(a);if(t.attachShader(i,c),t.attachShader(i,d),t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS))throw new Error(`glx: failed to link program: ${t.gl.getProgramInfoLog(i)}`);if(t.deleteShader(c),t.deleteShader(d),t.validateProgram(i),!t.getProgramParameter(i,t.VALIDATE_STATUS))throw new Error(`glx: failed to validate program: ${t.gl.getProgramInfoLog(i)}`);return i}}function ct(t){return function(r,s,o=t.createTexture()){return t.bindTexture(t.TEXTURE_2D,o),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),new Promise((a,h)=>{if(r){let i=new Image;i.onerror=c=>{h(c)},i.onload=()=>{let{width:c,height:d}=i;t.texImage2D(t.TEXTURE_2D,0,t.RGBA,c,d,0,t.RGBA,t.UNSIGNED_BYTE,i),a(o)},i.src=r,s!==void 0&&(i.crossOrigin=s)}else a(o)})}}function ut(t){return(e,r=t.STATIC_DRAW)=>{let s=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,s),t.bufferData(t.ARRAY_BUFFER,e,r),t.bindBuffer(t.ARRAY_BUFFER,null),s}}function ht(t){return(e,r=t.STATIC_DRAW)=>{let s=t.createBuffer();return t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,s),t.bufferData(t.ELEMENT_ARRAY_BUFFER,e,r),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),s}}function dt(t){return(e,r=e)=>{let s=t.createFramebuffer();return t.bindFramebuffer(t.FRAMEBUFFER,s),t.viewport(0,0,e,r),s}}function lt(t){return(e,r)=>{let s={};for(let o of r)s[o]=t.getUniformLocation(e,o);return s}}function ft(t,e){let{types:r,attributes:s}={types:["webgl2","webgl","experimental-webgl"],attributes:{antialias:!0},...e};for(let o of r)try{let a=t?.getContext(o,s);if(a)return a;throw new Error("glx: failed to create WebGL context")}catch(a){throw a}}var mt=`#version 300 es
in vec2 aPosition;

uniform vec2 uResolution;

out vec2 vTextureCoord;

void main() {
  // Convert from pixels to 0 -> 1.
  vTextureCoord = aPosition / uResolution;

  gl_Position = vec4(((vTextureCoord * 2.0) - 1.0) * vec2(1, -1), 0, 1);
}`,pt=`#version 300 es
precision highp float;

in vec2 vTextureCoord;

uniform sampler2D uSampler;
uniform float uThreshold;

out vec4 oColor;

void main() {
  vec4 c = texture(uSampler, vTextureCoord);
  float metaball = c.a > uThreshold ? 1.0 : 0.0;

  c.a = metaball;
  c.rgb = c.rgb * metaball;

  oColor = c;
}`,Y=2*Math.PI;function bt(t=0,e=1){return{x:e*Math.cos(t),y:e*Math.sin(t)}}var A=class{constructor(e=0,r=0){this.x=e,this.y=r}angle(){return Math.atan2(this.y,this.x)}length(){return Math.hypot(this.x,this.y)}dot(e={}){let{x:r=e,y:s=e}=e;return this.x*r+this.y*s}add(e={}){let{x:r=e,y:s=e}=e;return b(this.x+r,this.y+s)}subtract(e={}){let{x:r=e,y:s=e}=e;return b(this.x-r,this.y-s)}multiply(e={}){let{x:r=e,y:s=e}=e;return b(this.x*r,this.y*s)}divide(e={}){let{x:r=e,y:s=e}=e;return b(this.x/r,this.y/s)}plus(e){return this.copy(this.add(e))}minus(e){return this.copy(this.subtract(e))}times(e){return this.copy(this.multiply(e))}over(e){return this.copy(this.divide(e))}copy(e={}){let{x:r=e,y:s=e}=e;return this.x=r,this.y=s,this}clone(){return b(this.x,this.y)}equals(e){return this.x===e.x&&this.y===e.y}invert(){return this.times(-1)}normalize(){return this.over(this.length())}};function b(t,e){return new A(t,e)}function G(t,e,r,s){return(1-s)*(1-s)*t+2*(1-s)*s*r+s*s*e}function Et(t){return[parseInt(t.substring(1,3),16),parseInt(t.substring(3,5),16),parseInt(t.substring(5,7),16)]}function Tt(t,e=performance.now()){return(r=e,s=250)=>{r-e<=s&&t(e),e=r}}function gt(t=0,e=2){if(t===0)return"0 b";let r=["b","Kb","Mb","Gb","Tb","Pb","Eb","Zb","Yb"],s=Math.max(0,e),o=Math.floor(Math.log(t)/Math.log(1024));return`${parseFloat((t/Math.pow(1024,o)).toFixed(s))} ${r[o]}`}function g(t=""){return document.createRange().createContextualFragment(t)}var xt=["#fa5619","#243470","#efc126","#0d070b","#fffffd"],{createObjectURL:Rt,revokeObjectURL:wt}=self.URL||self.webkitURL,yt=xt.map(t=>new Promise((e,r)=>{let[s,o,a]=Et(t),h=`<svg
      height="10"
      width="10"
      xmlns="http://www.w3.org/2000/svg"
      xmlns:xlink="http://www.w3.org/1999/xlink">
      <defs>
        <radialGradient id="gradient">
          <stop offset="0%" stop-color="rgba(${s}, ${o}, ${a}, 0.9)" />
          <stop offset="90%" stop-color="rgba(${s}, ${o}, ${a}, 0.0)" />
        </radialGradient>
      </defs>
      <circle cx="5" cy="5" r="5" fill="url('#gradient')" />
    </svg>`,i=new Blob([h],{type:"image/svg+xml"}),c=Rt(i),d=new Image;d.onload=()=>{wt(c),e(d)},d.onerror=R=>{r(R)},d.src=c})),O=await Promise.all(yt);function V(){let t=O.shift();return O.push(t),t}var P=class extends A{constructor(e,r){super(e,r),this.t=performance.now()}},F=class{constructor(e=0,r=0,s=0){this.x=e,this.y=r,this.r=s,this.d=2*s}},I=class{constructor(e=1){this.brush=new V,this.drops=[],this.steps=[],this.sensitivity=e}draw(e){for(;this.drops.length>0;){let{x:r,y:s,r:o,d:a}=this.drops.shift();e.drawImage(this.brush,r-o,s-o,a,a)}return this}tick(e=performance.now()){if(this.steps=this.steps.filter(u=>e-u.t<200),e-this?.lastStep?.t>7.5&&this.step(this.lastStep.x,this.lastStep.y),this.done)return delete this.lastStep,delete this.lastTail,this;let{0:r,[this.steps.length-1]:s}=this.steps,o=this.lastTail??this.steps.at(-2)??r,a=s;this.lastTail=s;let h=1/(this.steps.length*this.sensitivity),i=[...this.steps].reverse().reduce((u,l,f,U)=>f?u.concat(l.subtract(U[f-1])):u,[]).reduce((u,l)=>u.add(l),b()).times(h),c=i.length(),d=a.subtract(o),R=o.add(d.multiply(.5)).add(i.multiply(Math.max(0,1-Math.log(c)))),N=Math.max(2,(c-10)*.25+T(-2,2)),J=1/d.length();for(let u=0;u<=1;u+=J){let l=G(o.x,a.x,R.x,u),f=G(o.y,a.y,R.y,u);this.drop(l,f,N)}Array.from({length:v(k(Math.max(0,c-20)*5),1e3)},()=>c).map(u=>u*.05).forEach(u=>{let l=st(Math.min(1,u),Math.random(),Math.pow(Math.random(),4)*u),f=T(Math.PI,-Math.PI)/3,U=-1*Math.sin(f)*Math.cos(f),tt=Math.pow(Math.random(),4)*Math.min(1/l,1)*c*.5,{x:et,y:rt}=b(i.multiply(l).dot(U)).plus(a);this.drop(et,rt,tt)});let X=s.t-r.t,Q=T(X*.1),q=T(X*.3);return Array.from({length:v(2-c/5,1e3)},()=>T(Y)).map(u=>bt(u,q)).forEach(u=>{let{x:l,y:f}=s.add(u);this.drop(l,f,Q)}),this}drop(e,r,s){let o=new F(e,r,s);this.drops.push(o)}step(e,r){return this.lastStep=new P(e,r),this}set lastStep(e){this.steps.push(e)}get done(){return this.steps.length===0}},L=class{constructor(e=0,r=e,s=0){this.max=s,this.x=e,this.y=r}reset(e,r,s){this.max=s??this.max,this.x=e??this.x,this.y=r??this.y}walk(e=1,r=this.max){let s=Math.min(e,r),o=k(Y);return this.x+=s*Math.cos(o),this.y+=s*Math.sin(o),this}},vt=(t=Math.random())=>Math.tan(Math.PI*(t-.5)),At=t=>(e=Math.random())=>1/Math.pow(1-e,1/t),_=document.querySelector("#save"),E=document.querySelector("progress"),_t=document.querySelector("#clear"),w=document.querySelector("#draw"),x=document.querySelector("#statusline"),S=document.querySelector("canvas"),$=nt(Ot),Mt={preserveDrawingBuffer:!0},{gl:n,createVbo:St,createProgram:Ut}=ot(S,{attributes:Mt}),B=S.cloneNode().getContext("2d"),{width:m,height:p}=S;console.log(n);var Pt=[1,1,1],Ft=[...Pt,0],It=Float32Array.BYTES_PER_ELEMENT,W=new Float32Array([0,0,0,p,m,0,m,0,0,p,m,p]),y=Ut(mt,pt),Lt=St(W),D=n.getAttribLocation(y,"aPosition");D!==-1&&n.enableVertexAttribArray(D);var Bt=n.getUniformLocation(y,"uResolution"),Dt=n.getUniformLocation(y,"uSampler"),Ct=n.getUniformLocation(y,"uThreshold"),H=n.createTexture();n.activeTexture(n.TEXTURE0+0);n.bindTexture(n.TEXTURE_2D,H);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST);n.useProgram(y);var{searchParams:C}=new URL(document.location),kt=C.has("cauchy")?vt:At(1.26),$t=C.has("duration")?C.get("duration"):10;200*parseInt($t,10);var z=new I,Nt=(...t)=>Array.from({length:t.length},(e,r)=>k(0,t.at(r))),Xt=[m,p].map(t=>t*.5),Gt=Tt(()=>{z.brush=new V}),j=[],M=new Proxy(j,{set(t,e,r){let s=Reflect.set(t,e,r);if(t.length&&e==="length"){let o=parseInt(t.length%20/20*100,10),a=String(o).padStart(3," ");o?(x.replaceChildren(g(`Running&hellip; <code>${a}%</code>`)),E.setAttribute("value",o),_.removeAttribute("disabled")):(x.replaceChildren(g(`Okay, <code>${t.length}</code> frames in store`)),E.setAttribute("value",0),w.removeAttribute("disabled"))}return t.length&&t.length%20===0&&$.stop(),t.length?_.removeAttribute("disabled"):w.removeAttribute("disabled"),s}}),K=new L(...Xt,50),Z=new Worker("worker.js");Z.addEventListener("message",t=>{let{image:e,step:r,error:s}=t.data;if(s&&(E.setAttribute("value",0),console.error(s)),r){let{index:o,total:a}=r,{length:h}=String(a),i=parseInt((o+1)/a*100,10),c=String(i).padStart(h," ");x.replaceChildren(g(`Processing&hellip; <code>${c}%</code>`)),E.setAttribute("value",i)}if(e){let{data:o,size:a}=e,h=`Splash.${Date.now()}.gif`,i=`<a href="data:image/gif;base64,${o}" download="${h}"><strong>${h}</strong></a>`,c=gt(a);M.splice(0,M.length),x.replaceChildren(g(`All set! ${i} <code>${c}</code>`)),E.setAttribute("value",0)}});w.addEventListener("click",function(){w.setAttribute("disabled",""),x.replaceChildren(g("Running&hellip;")),K.reset(...Nt(m,p)),E.removeAttribute("value"),$.start()},{passive:!0});_t.addEventListener("click",function(){B.clearRect(0,0,m,p),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT)});_.addEventListener("click",function(){M.length!==0&&(w.setAttribute("disabled",""),_.setAttribute("disabled",""),x.replaceChildren(g("Uploading&hellip;")),Z.postMessage({store:j}),E.removeAttribute("value"),$.stop())},{passive:!0});function Ot(t,e){let r=kt(),s=K.walk(r),o=v(s.x,m),a=v(s.y,p);z.step(o,a).tick().draw(B),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,m,p,0,n.RGBA,n.UNSIGNED_BYTE,B.canvas),n.generateMipmap(n.TEXTURE_2D),n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight),n.clearColor(...Ft),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),n.bindBuffer(n.ARRAY_BUFFER,Lt),n.uniform2f(Bt,m,p),n.uniform1i(Dt,H),n.uniform1f(Ct,.75),n.vertexAttribPointer(D,2,n.FLOAT,n.TRUE,2*It,0),n.drawArrays(n.TRIANGLES,0,W.length/2),e%100===0&&Gt(),e%10===0&&M.push(S.toDataURL())}
